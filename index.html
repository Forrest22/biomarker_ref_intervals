<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UKB Biomarker Reference Intervals</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for the font and rounded corners */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            border-radius: 1rem; /* Rounded corners for the main container */
        }
        .chart-card {
            border-radius: 0.75rem; /* Rounded corners for individual chart cards */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .tooltip {
            position: absolute;
            text-align: left; /* Changed to left for better multi-line readability */
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.8); /* Darker background for better contrast */
            color: #fff;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            font-size: 0.875rem; /* Smaller font for tooltip */
        }
        /* Removed .range-slider-container styles as it's no longer needed */
        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: all; /* Allow mouse events */
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto bg-white p-6 md:p-8 shadow-lg rounded-xl">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-indigo-700">
            UKB Biomarker Reference Intervals
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Visualizing 95% reference intervals for blood and urine biomarkers across ages, split by sex.
        </p>

        <!-- Controls Section -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8 p-4 bg-indigo-50 rounded-lg shadow-inner">
            <!-- Biomarker Selection Dropdown -->
            <div class="flex items-center space-x-4">
                <label for="biomarker-select" class="font-semibold text-indigo-800">Biomarker:</label>
                <select id="biomarker-select" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- Sex Filter Checkboxes -->
            <div class="flex items-center space-x-4">
                <label class="font-semibold text-indigo-800">Show Sexes:</label>
                <div class="flex space-x-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox text-black" name="sex-checkbox" value="Both" checked>
                        <span class="ml-2 text-gray-700">Both</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox text-blue-600" name="sex-checkbox" value="Male" checked>
                        <span class="ml-2 text-gray-700">Male</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox text-pink-600" name="sex-checkbox" value="Female" checked>
                        <span class="ml-2 text-gray-700">Female</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Single Chart Container -->
        <div id="single-chart-container" class="chart-card bg-white p-4 rounded-lg shadow-md flex justify-center items-center">
            <!-- The single chart will be dynamically loaded here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const singleChartContainer = d3.select("#single-chart-container");
            const biomarkerSelect = document.getElementById('biomarker-select');
            const sexCheckboxes = document.querySelectorAll('input[name="sex-checkbox"]');

            let mockData = []; // This will hold the loaded or generated data
            let allBiomarkers = [];
            let selectedBiomarker = '';
            let selectedSexes = ['Both', 'Male', 'Female']; // Default to all selected

            // Define colors for each sex
            const sexColors = {
                'Both': { line: 'black', area: 'rgba(0, 0, 0, 0.1)' }, // Lighter black
                'Male': { line: 'dodgerblue', area: 'rgba(30, 144, 255, 0.2)' }, // Lighter dodgerblue
                'Female': { line: 'deeppink', area: 'rgba(255, 20, 147, 0.2)' } // Lighter deeppink
            };

            // Internal Mock Data Generation
            function generateInternalMockData() {
                const biomarkers = [
                    { name: "Blood Glucose", unit: "mmol/L", base: 5, maleOffset: 0.1, femaleOffset: -0.1, bothOffset: 0, ageEffect: 0.02, variability: 0.5 },
                    { name: "Creatinine", unit: "µmol/L", base: 80, maleOffset: 5, femaleOffset: -5, bothOffset: 0, ageEffect: 0.1, variability: 10 },
                    { name: "Urea", unit: "mmol/L", base: 4, maleOffset: 0.2, femaleOffset: -0.2, bothOffset: 0, ageEffect: 0.05, variability: 1 },
                    { name: "Total Cholesterol", unit: "mmol/L", base: 4.5, maleOffset: 0.1, femaleOffset: 0.1, bothOffset: 0, ageEffect: 0.03, variability: 0.8 },
                    { name: "HDL Cholesterol", unit: "mmol/L", base: 1.2, maleOffset: -0.1, femaleOffset: 0.1, bothOffset: 0, ageEffect: 0.01, variability: 0.2 },
                    { name: "LDL Cholesterol", unit: "mmol/L", base: 2.5, maleOffset: 0.1, femaleOffset: 0.1, bothOffset: 0, ageEffect: 0.02, variability: 0.5 },
                    { name: "Uric Acid", unit: "µmol/L", base: 250, maleOffset: 20, femaleOffset: -20, bothOffset: 0, ageEffect: 0.5, variability: 50 },
                    { name: "Sodium", unit: "mmol/L", base: 140, maleOffset: 0, femaleOffset: 0, bothOffset: 0, ageEffect: 0.01, variability: 2 },
                    { name: "Potassium", unit: "mmol/L", base: 4.0, maleOffset: 0, femaleOffset: 0, bothOffset: 0, ageEffect: 0.005, variability: 0.3 },
                    { name: "Albumin", unit: "g/L", base: 40, maleOffset: 0, femaleOffset: 0, bothOffset: 0, ageEffect: -0.05, variability: 3 },
                ];

                const data = [];
                for (let age = 20; age <= 80; age++) {
                    biomarkers.forEach(bm => {
                        // Male data
                        let maleMean = bm.base + (age - 20) * bm.ageEffect + bm.maleOffset;
                        let maleLower = maleMean - bm.variability * 0.5;
                        let maleUpper = maleMean + bm.variability * 0.5;
                        data.push({
                            biomarker: bm.name,
                            unit: bm.unit,
                            age: age,
                            sex: 'Male',
                            lower: maleLower,
                            upper: maleUpper,
                            mean: maleMean
                        });

                        // Female data
                        let femaleMean = bm.base + (age - 20) * bm.ageEffect + bm.femaleOffset;
                        let femaleLower = femaleMean - bm.variability * 0.5;
                        let femaleUpper = femaleMean + femaleMean * 0.5;
                        data.push({
                            biomarker: bm.name,
                            unit: bm.unit,
                            age: age,
                            sex: 'Female',
                            lower: femaleLower,
                            upper: femaleUpper,
                            mean: femaleMean
                        });

                        // 'Both' data (average of male and female, or a separate calculation)
                        let bothMean = (maleMean + femaleMean) / 2 + bm.bothOffset;
                        let bothLower = Math.min(maleLower, femaleLower) - bm.variability * 0.1;
                        let bothUpper = Math.max(maleUpper, femaleUpper) + bm.variability * 0.1;
                        data.push({
                            biomarker: bm.name,
                            unit: bm.unit,
                            age: age,
                            sex: 'Both',
                            lower: bothLower,
                            upper: bothUpper,
                            mean: bothMean
                        });
                    });
                }
                return data;
            }

            // Function to draw the single biomarker chart
            function drawSingleChart(biomarkerName, data, unit) {
                singleChartContainer.html(""); // Clear existing chart

                const margin = { top: 40, right: 80, bottom: 60, left: 70 };
                const containerWidth = singleChartContainer.node().getBoundingClientRect().width;
                const width = containerWidth - margin.left - margin.right;
                const height = 450 - margin.top - margin.bottom;

                const svg = singleChartContainer.append("svg")
                    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                    .attr("preserveAspectRatio", "xMinYMin meet")
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Scales
                const x = d3.scaleLinear()
                    .domain([20, 80]) // Fixed domain for age
                    .range([0, width]);

                let yMin = d3.min(data.filter(d => selectedSexes.includes(d.sex)), d => d.lower) * 0.9;
                let yMax = d3.max(data.filter(d => selectedSexes.includes(d.sex)), d => d.upper) * 1.1;

                if (isNaN(yMin) || isNaN(yMax)) {
                    yMin = 0;
                    yMax = 10;
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .style("font-size", "1.2rem")
                        .style("fill", "gray")
                        .text("No data to display for selected filters.");
                    return;
                }

                const y = d3.scaleLinear()
                    .domain([yMin, yMax])
                    .range([height, 0]);

                // Axes
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d3.format("d")));

                svg.append("g")
                    .call(d3.axisLeft(y));

                // Axis labels
                svg.append("text")
                    .attr("transform", `translate(${width / 2},${height + margin.bottom - 10})`)
                    .style("text-anchor", "middle")
                    .text("Age (Years)");

                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left + 15)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text(`${biomarkerName} (${unit})`);

                // Chart Title
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", 0 - (margin.top / 2) + 10)
                    .attr("text-anchor", "middle")
                    .style("font-size", "1.5rem")
                    .style("font-weight", "bold")
                    .text(`${biomarkerName} Reference Intervals`);

                // Draw data for each selected sex
                selectedSexes.forEach(sex => {
                    const sexData = data.filter(d => d.sex === sex);

                    if (sexData.length > 0) {
                        const area = d3.area()
                            .x(d => x(d.age))
                            .y0(d => y(d.lower))
                            .y1(d => y(d.upper));

                        svg.append("path")
                            .datum(sexData)
                            .attr("fill", sexColors[sex].area)
                            .attr("stroke", "none")
                            .attr("d", area);

                        const line = d3.line()
                            .x(d => x(d.age))
                            .y(d => y(d.mean));

                        svg.append("path")
                            .datum(sexData)
                            .attr("fill", "none")
                            .attr("stroke", sexColors[sex].line)
                            .attr("stroke-width", 2)
                            .attr("d", line);
                    }
                });

                // Tooltip and Hover functionality
                const tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");

                const focus = svg.append("g")
                    .attr("class", "focus")
                    .style("display", "none");

                focus.append("line")
                    .attr("class", "x-hover-line hover-line")
                    .attr("y1", 0)
                    .attr("y2", height)
                    .attr("stroke", "gray")
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "3,3");

                svg.append("rect")
                    .attr("class", "overlay")
                    .attr("width", width)
                    .attr("height", height)
                    .style("fill", "none")
                    .style("pointer-events", "all")
                    .on("mouseover", () => { focus.style("display", null); tooltip.transition().duration(200).style("opacity", .9); })
                    .on("mouseout", () => { focus.style("display", "none"); tooltip.transition().duration(500).style("opacity", 0); })
                    .on("mousemove", mousemove);

                function mousemove(event) {
                    const bisectAge = d3.bisector(d => d.age).left;
                    const x0 = x.invert(d3.pointer(event)[0]);

                    focus.select(".x-hover-line").attr("transform", `translate(${x(x0)},0)`);

                    let tooltipHtml = `Age: ${Math.round(x0)}<br/>`;

                    selectedSexes.forEach(sex => {
                        const sexData = data.filter(d => d.sex === sex);

                        if (sexData.length > 0) {
                            sexData.sort((a, b) => a.age - b.age);
                            const i = bisectAge(sexData, x0, 1);
                            const d0 = sexData[i - 1];
                            const d1 = sexData[i];
                            const d = (d0 && d1) ? (x0 - d0.age > d1.age - x0 ? d1 : d0) : (d0 || d1);

                            if (d) {
                                tooltipHtml += `<span style="color:${sexColors[sex].line};">${sex}:</span> Mean ${d.mean.toFixed(2)} ${unit}<br/>`;
                                tooltipHtml += `<span style="color:${sexColors[sex].line};">&nbsp;&nbsp;95% CI: ${d.lower.toFixed(2)} - ${d.upper.toFixed(2)} ${unit}</span><br/>`;
                            }
                        }
                    });

                    tooltip.html(tooltipHtml)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                }
            }

            function updateChart() {
                let filteredData = mockData.filter(d => d.biomarker === selectedBiomarker);
                const unit = filteredData.length > 0 ? filteredData[0].unit : '';
                drawSingleChart(selectedBiomarker, filteredData, unit);
            }

            // Function to initialize the chart with data
            function initializeChart(dataToUse, sourceMessage) {
                mockData = dataToUse;
                allBiomarkers = [...new Set(mockData.map(d => d.biomarker))];

                biomarkerSelect.innerHTML = ''; // Clear previous options
                allBiomarkers.forEach(biomarker => {
                    const option = document.createElement('option');
                    option.value = biomarker;
                    option.textContent = biomarker;
                    biomarkerSelect.appendChild(option);
                });
                selectedBiomarker = allBiomarkers[0];

                // Event Listeners
                biomarkerSelect.addEventListener('change', (event) => {
                    selectedBiomarker = event.target.value;
                    updateChart();
                });

                sexCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (event) => {
                        selectedSexes = Array.from(sexCheckboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.value);
                        updateChart();
                    });
                });

                updateChart(); // Initial rendering
                window.addEventListener('resize', updateChart); // Responsive resize

                if (sourceMessage) {
                    console.log(sourceMessage);
                    // Optionally display this message on the UI for the user
                    // For example: singleChartContainer.append("p").text(sourceMessage).style("color", "gray");
                }
            }

            // Attempt to load data from CSV first
            d3.csv("ukb_biomarker_reference_intervals.eur.csv").then(function(loadedData) {
                // Parse numerical values from strings
                const parsedData = loadedData.map(d => ({
                    biomarker: d.biomarker,
                    unit: d.unit,
                    age: parseInt(d.age),
                    sex: d.sex,
                    lower: parseFloat(d.lower),
                    upper: parseFloat(d.upper),
                    mean: parseFloat(d.mean)
                }));
                initializeChart(parsedData, "Data loaded from mock_data.csv");
            }).catch(function(error) {
                console.warn("Could not load mock_data.csv. Falling back to internal mock data.", error);
                initializeChart(generateInternalMockData(), "Using internally generated mock data.");
            });
        });
    </script>
</body>
</html>
